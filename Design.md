# Open Claude Cowork - æ¶æ„è®¾è®¡æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

Open Claude Cowork æ˜¯ä¸€ä¸ªåŸºäº Electron æ¡†æ¶æ„å»ºçš„è·¨å¹³å°æ¡Œé¢åº”ç”¨ï¼Œä¸º Claude Code æä¾›å¯è§†åŒ–å›¾å½¢ç•Œé¢ã€‚å®ƒä½œä¸º AI åä½œåŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·è¿›è¡Œç¼–ç¨‹ã€æ–‡ä»¶ç®¡ç†å’Œå„ç§å¯æè¿°çš„ä»»åŠ¡ã€‚

### æ ¸å¿ƒç‰¹æ€§
- ğŸ–¥ï¸ åŸç”Ÿè·¨å¹³å°æ¡Œé¢åº”ç”¨ï¼ˆmacOSã€Windowsã€Linuxï¼‰
- ğŸ¤– AI åä½œä¼™ä¼´ï¼Œæ”¯æŒä»£ç ç¼–å†™ã€æ–‡ä»¶ç®¡ç†ã€å‘½ä»¤æ‰§è¡Œ
- ğŸ” **ç‹¬ç«‹è¿è¡Œæ¨¡å¼**ï¼šå†…ç½® Claude Code CLIï¼Œæ— éœ€ç”¨æˆ·å•ç‹¬å®‰è£…
- ğŸ”‘ **å®‰å…¨é…ç½®ç®¡ç†**ï¼šåº”ç”¨å†… API é…ç½®ç•Œé¢ï¼Œä½¿ç”¨ Electron safeStorage åŠ å¯†å­˜å‚¨
- ğŸ” å…¼å®¹ Claude Code é…ç½®ï¼ˆé¦–æ¬¡å¯åŠ¨è‡ªåŠ¨ä» `~/.claude/settings.json` è¿ç§»ï¼‰
- ğŸ“‚ ä¼šè¯ç®¡ç†ä¸å†å²è®°å½•æŒä¹…åŒ–
- ğŸ¯ å®æ—¶æµå¼è¾“å‡ºï¼Œæ”¯æŒå·¥å…·æƒé™æ§åˆ¶
- ğŸ’¾ åŸºäº SQLite çš„æœ¬åœ°æ•°æ®å­˜å‚¨

---

## 2. Electron æ¡†æ¶åŸç†

### 2.1 åŒè¿›ç¨‹æ¶æ„

Electron é‡‡ç”¨å¤šè¿›ç¨‹æ¶æ„ï¼Œä¸»è¦åˆ†ä¸ºä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Main Process (Node.js)          â”‚
â”‚  - çª—å£ç®¡ç† (BrowserWindow)              â”‚
â”‚  - ç³»ç»Ÿ API è®¿é—®                         â”‚
â”‚  - åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†                       â”‚
â”‚  - æ–‡ä»¶ç³»ç»Ÿã€æ•°æ®åº“æ“ä½œ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ IPC (è¿›ç¨‹é—´é€šä¿¡)
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Renderer Process (Chromium)          â”‚
â”‚  - Web UI (React)                       â”‚
â”‚  - ç”¨æˆ·ç•Œé¢æ¸²æŸ“                          â”‚
â”‚  - å—é™çš„ API è®¿é—®ï¼ˆé€šè¿‡ Preloadï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å®‰å…¨æ¨¡å‹

- **Context Isolation**: æ¸²æŸ“è¿›ç¨‹ä¸ Node.js ç¯å¢ƒéš”ç¦»
- **Preload Script**: é€šè¿‡ `contextBridge` å®‰å…¨åœ°æš´éœ² API
- **IPC é€šä¿¡**: ä½¿ç”¨ `ipcMain` å’Œ `ipcRenderer` è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡

### 2.3 è·¨å¹³å°èƒ½åŠ›

- ç»Ÿä¸€ä»£ç åº“ï¼Œé’ˆå¯¹ä¸åŒå¹³å°æ‰“åŒ…
- ä½¿ç”¨ `electron-builder` ç”Ÿæˆå¹³å°ç‰¹å®šçš„å®‰è£…åŒ…
- æ”¯æŒå¹³å°ç‰¹å®šçš„ UI è°ƒæ•´ï¼ˆå¦‚ macOS çš„ trafficLight æŒ‰é’®ï¼‰

---

## 3. é¡¹ç›®æ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Electron Application                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Main Process       â”‚â—„â”€â”€â”€IPCâ”€â–ºâ”‚ Renderer Process   â”‚   â”‚
â”‚  â”‚   (Node.js)          â”‚         â”‚ (React + Vite)     â”‚   â”‚
â”‚  â”‚                      â”‚         â”‚                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ main.ts          â”‚         â”‚  â”œâ”€ App.tsx        â”‚   â”‚
â”‚  â”‚  â”œâ”€ ipc-handlers.ts  â”‚         â”‚  â”œâ”€ components/    â”‚   â”‚
â”‚  â”‚  â”œâ”€ preload.cts      â”‚         â”‚  â”œâ”€ store/         â”‚   â”‚
â”‚  â”‚  â””â”€ libs/            â”‚         â”‚  â””â”€ hooks/         â”‚   â”‚
â”‚  â”‚     â”œâ”€ runner.ts     â”‚         â”‚                    â”‚   â”‚
â”‚  â”‚     â”œâ”€ session-store â”‚         â”‚                    â”‚   â”‚
â”‚  â”‚     â”œâ”€ config-store  â”‚         â”‚                    â”‚   â”‚
â”‚  â”‚     â””â”€ claude-settingsâ”‚        â”‚                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                 â”‚               â”‚
â”‚           â”‚                                 â”‚               â”‚
â”‚           â–¼                                 â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  SQLite Database â”‚              â”‚  Zustand Store â”‚      â”‚
â”‚  â”‚  (sessions.db)   â”‚              â”‚  (çŠ¶æ€ç®¡ç†)     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â”‚                                                 â”‚
â”‚           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ Claude Agent SDK             â”‚                          â”‚
â”‚  â”‚ (@anthropic-ai/claude-agent) â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚           â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Claude API     â”‚
   â”‚  (Anthropic)    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ç›®å½•ç»“æ„

```
Claude-Cowork/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ electron/              # ä¸»è¿›ç¨‹ä»£ç 
â”‚   â”‚   â”œâ”€â”€ main.ts            # åº”ç”¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ ipc-handlers.ts    # IPC äº‹ä»¶å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ preload.cts        # é¢„åŠ è½½è„šæœ¬ï¼ˆå®‰å…¨æ¡¥æ¥ï¼‰
â”‚   â”‚   â”œâ”€â”€ pathResolver.ts    # è·¯å¾„è§£æå·¥å…·
â”‚   â”‚   â”œâ”€â”€ util.ts            # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ types.ts           # TypeScript ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ libs/              # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚       â”œâ”€â”€ runner.ts      # Claude Agent æ‰§è¡Œå™¨
â”‚   â”‚       â”œâ”€â”€ session-store.ts # ä¼šè¯å­˜å‚¨ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ config-store.ts # é…ç½®å­˜å‚¨ï¼ˆAPI Key åŠ å¯†ï¼‰
â”‚   â”‚       â”œâ”€â”€ claude-settings.ts # Claude ç¯å¢ƒå˜é‡æ„å»º
â”‚   â”‚       â””â”€â”€ util.ts        # ä¸šåŠ¡å·¥å…·å‡½æ•°
â”‚   â”‚
â”‚   â””â”€â”€ ui/                    # æ¸²æŸ“è¿›ç¨‹ä»£ç 
â”‚       â”œâ”€â”€ App.tsx            # ä¸»åº”ç”¨ç»„ä»¶
â”‚       â”œâ”€â”€ main.tsx           # React å…¥å£
â”‚       â”œâ”€â”€ types.ts           # UI ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ components/        # React ç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ Sidebar.tsx            # ä¼šè¯ä¾§è¾¹æ ï¼ˆå«è®¾ç½®æŒ‰é’®ï¼‰
â”‚       â”‚   â”œâ”€â”€ PromptInput.tsx        # è¾“å…¥æ¡†
â”‚       â”‚   â”œâ”€â”€ EventCard.tsx          # æ¶ˆæ¯å¡ç‰‡
â”‚       â”‚   â”œâ”€â”€ DecisionPanel.tsx      # æƒé™å†³ç­–é¢æ¿
â”‚       â”‚   â”œâ”€â”€ StartSessionModal.tsx  # åˆ›å»ºä¼šè¯æ¨¡æ€æ¡†
â”‚       â”‚   â””â”€â”€ SettingsModal.tsx      # API é…ç½®æ¨¡æ€æ¡†
â”‚       â”œâ”€â”€ hooks/             # React Hooks
â”‚       â”‚   â””â”€â”€ useIPC.ts      # IPC é€šä¿¡ Hook
â”‚       â”œâ”€â”€ store/             # çŠ¶æ€ç®¡ç†
â”‚       â”‚   â””â”€â”€ useAppStore.ts # Zustand å…¨å±€çŠ¶æ€
â”‚       â””â”€â”€ render/            # æ¸²æŸ“å·¥å…·
â”‚           â””â”€â”€ markdown.tsx   # Markdown æ¸²æŸ“å™¨
â”‚
â”œâ”€â”€ dist-electron/             # ä¸»è¿›ç¨‹ç¼–è¯‘è¾“å‡º
â”œâ”€â”€ dist/                      # æ¸²æŸ“è¿›ç¨‹æ‰“åŒ…è¾“å‡º
â”œâ”€â”€ package.json               # ä¾èµ–é…ç½®
â”œâ”€â”€ vite.config.ts             # Vite é…ç½®
â”œâ”€â”€ electron-builder.json      # Electron æ‰“åŒ…é…ç½®
â””â”€â”€ tsconfig.*.json            # TypeScript é…ç½®
```

---

## 4. æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 4.1 ä¸»è¿›ç¨‹æ¨¡å— (Main Process)

#### 4.1.1 `main.ts` - åº”ç”¨å…¥å£
**èŒè´£ï¼š**
- åˆ›å»ºå¹¶ç®¡ç†åº”ç”¨çª—å£
- é…ç½®çª—å£å±æ€§ï¼ˆå¤§å°ã€æœ€å°å°ºå¯¸ã€å›¾æ ‡ã€æ ‡é¢˜æ æ ·å¼ï¼‰
- æ³¨å†Œ IPC å¤„ç†å™¨
- åŠ è½½ UIï¼ˆå¼€å‘æ¨¡å¼åŠ è½½ Vite æœåŠ¡å™¨ï¼Œç”Ÿäº§æ¨¡å¼åŠ è½½é™æ€æ–‡ä»¶ï¼‰

**å…³é”®é€»è¾‘ï¼š**
```typescript
app.on("ready", () => {
  // åˆ›å»ºä¸»çª—å£
  const mainWindow = new BrowserWindow({
    webPreferences: {
      preload: getPreloadPath(),  // åŠ è½½é¢„åŠ è½½è„šæœ¬
    }
  });
  
  // æ³¨å†Œ IPC å¤„ç†å™¨
  ipcMainHandle("generate-session-title", ...);
  ipcMainHandle("get-recent-cwds", ...);
  ipcMainHandle("select-directory", ...);
  ipcMain.on("client-event", handleClientEvent);
});
```

#### 4.1.2 `ipc-handlers.ts` - äº‹ä»¶å¤„ç†ä¸­å¿ƒ
**èŒè´£ï¼š**
- å¤„ç†æ‰€æœ‰æ¥è‡ªæ¸²æŸ“è¿›ç¨‹çš„å®¢æˆ·ç«¯äº‹ä»¶
- ç®¡ç† Claude Agent è¿è¡Œæ—¶å®ä¾‹
- åè°ƒä¼šè¯çŠ¶æ€æ›´æ–°
- å¹¿æ’­æœåŠ¡å™¨äº‹ä»¶åˆ°æ‰€æœ‰çª—å£

**æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š**
- `sessions: SessionStore` - ä¼šè¯å­˜å‚¨å®ä¾‹
- `runnerHandles: Map<string, RunnerHandle>` - è¿è¡Œä¸­çš„ Agent å¥æŸ„

**ä¸»è¦äº‹ä»¶å¤„ç†ï¼š**

| äº‹ä»¶ç±»å‹ | åŠŸèƒ½ | è§¦å‘æ—¶æœº |
|---------|------|---------|
| `session.list` | è¿”å›æ‰€æœ‰ä¼šè¯åˆ—è¡¨ | UI å¯åŠ¨æ—¶ |
| `session.history` | è·å–ä¼šè¯å†å²æ¶ˆæ¯ | åˆ‡æ¢åˆ°å·²æœ‰ä¼šè¯ |
| `session.start` | å¯åŠ¨æ–°ä¼šè¯ | ç”¨æˆ·åˆ›å»ºæ–°ä»»åŠ¡ |
| `session.continue` | ç»§ç»­ç°æœ‰ä¼šè¯ | ç”¨æˆ·è¿½åŠ è¾“å…¥ |
| `session.stop` | åœæ­¢è¿è¡Œä¸­çš„ä¼šè¯ | ç”¨æˆ·æ‰‹åŠ¨ä¸­æ­¢ |
| `session.delete` | åˆ é™¤ä¼šè¯ | ç”¨æˆ·åˆ é™¤å†å² |
| `permission.response` | å¤„ç†æƒé™å“åº” | ç”¨æˆ·æ‰¹å‡†/æ‹’ç»å·¥å…· |

**äº‹ä»¶æµç¤ºä¾‹ï¼ˆå¯åŠ¨æ–°ä¼šè¯ï¼‰ï¼š**
```
UI â†’ client-event: session.start
  â†“
ipc-handlers.ts
  â”œâ”€ sessions.createSession()
  â”œâ”€ emit: session.status (running)
  â”œâ”€ runClaude() â†’ Claude Agent SDK
  â””â”€ emit: stream.user_prompt
       â†“
Claude Agent SDK æµå¼è¾“å‡º
  â”œâ”€ emit: stream.message (thinking/tool_use/result)
  â””â”€ emit: session.status (completed/error)
       â†“
broadcast â†’ æ‰€æœ‰çª—å£æ¥æ”¶äº‹ä»¶
```

#### 4.1.3 `preload.cts` - å®‰å…¨æ¡¥æ¥å±‚
**èŒè´£ï¼š**
- é€šè¿‡ `contextBridge` å®‰å…¨åœ°æš´éœ² API ç»™æ¸²æŸ“è¿›ç¨‹
- å°è£… IPC é€šä¿¡æ¥å£
- æä¾›ç±»å‹å®‰å…¨çš„ API

**æš´éœ²çš„ APIï¼š**
```typescript
window.electron = {
  sendClientEvent,      // å‘é€å®¢æˆ·ç«¯äº‹ä»¶
  onServerEvent,        // è®¢é˜…æœåŠ¡å™¨äº‹ä»¶
  generateSessionTitle, // ç”Ÿæˆä¼šè¯æ ‡é¢˜
  getRecentCwds,        // è·å–æœ€è¿‘å·¥ä½œç›®å½•
  selectDirectory,      // æ‰“å¼€ç›®å½•é€‰æ‹©å™¨
}
```

#### 4.1.4 `libs/runner.ts` - Claude Agent æ‰§è¡Œå™¨
**èŒè´£ï¼š**
- å°è£… Claude Agent SDK çš„ `query()` å‡½æ•°
- ç®¡ç† Agent ç”Ÿå‘½å‘¨æœŸï¼ˆå¯åŠ¨ã€ä¸­æ­¢ï¼‰
- å¤„ç†æµå¼æ¶ˆæ¯è¾“å‡º
- å®ç°å·¥å…·æƒé™æ§åˆ¶

**æ ¸å¿ƒå‡½æ•°ï¼š`runClaude()`**
- æ¥æ”¶å‚æ•°ï¼š`prompt`ã€`session`ã€`resumeSessionId`ã€`onEvent`ã€`onSessionUpdate`
- åˆ›å»º `AbortController` æ”¯æŒä¸­æ­¢
- é…ç½® Agent é€‰é¡¹ï¼šå·¥ä½œç›®å½•ã€ç¯å¢ƒå˜é‡ã€æƒé™æ¨¡å¼
- å¤„ç† `AskUserQuestion` å·¥å…·çš„ç”¨æˆ·äº¤äº’ï¼ˆç­‰å¾…ç”¨æˆ·å“åº”ï¼‰
- æµå¼è¾“å‡ºæ¶ˆæ¯åˆ°å‰ç«¯
- æ•è· `session_id` ç”¨äºç»­å†™ä¼šè¯

**æƒé™æ§åˆ¶æœºåˆ¶ï¼š**
```typescript
canUseTool: async (toolName, input) => {
  if (toolName === "AskUserQuestion") {
    // éœ€è¦ç”¨æˆ·æ‰¹å‡†
    sendPermissionRequest(toolUseId, toolName, input);
    return new Promise((resolve) => {
      session.pendingPermissions.set(toolUseId, { resolve });
    });
  }
  // å…¶ä»–å·¥å…·è‡ªåŠ¨æ‰¹å‡†
  return { behavior: "allow" };
}
```

#### 4.1.5 `libs/session-store.ts` - ä¼šè¯æŒä¹…åŒ–
**èŒè´£ï¼š**
- åŸºäº SQLite (better-sqlite3) çš„ä¼šè¯ç®¡ç†
- CRUD æ“ä½œï¼šåˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤ä¼šè¯
- å­˜å‚¨ä¼šè¯å…ƒæ•°æ®å’Œå†å²æ¶ˆæ¯
- æä¾›æœ€è¿‘å·¥ä½œç›®å½•åˆ—è¡¨

**æ•°æ®åº“è¡¨ç»“æ„ï¼š**
- `sessions` è¡¨ï¼šå­˜å‚¨ä¼šè¯å…ƒæ•°æ®ï¼ˆidã€titleã€statusã€cwdã€createdAt ç­‰ï¼‰
- `messages` è¡¨ï¼šå­˜å‚¨ä¼šè¯æ¶ˆæ¯å†å²ï¼ˆsessionIdã€messageTypeã€contentã€createdAtï¼‰

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `createSession()` - åˆ›å»ºæ–°ä¼šè¯
- `updateSession()` - æ›´æ–°ä¼šè¯çŠ¶æ€
- `recordMessage()` - è®°å½•æ¶ˆæ¯
- `getSessionHistory()` - è·å–å®Œæ•´å†å²
- `listSessions()` - åˆ—å‡ºæ‰€æœ‰ä¼šè¯
- `listRecentCwds()` - è·å–æœ€è¿‘ä½¿ç”¨çš„å·¥ä½œç›®å½•
- `deleteSession()` - åˆ é™¤ä¼šè¯åŠç›¸å…³æ¶ˆæ¯

#### 4.1.6 `libs/config-store.ts` - é…ç½®å­˜å‚¨
**èŒè´£ï¼š**
- ç®¡ç†åº”ç”¨é…ç½®çš„æŒä¹…åŒ–å­˜å‚¨
- ä½¿ç”¨ Electron `safeStorage` API åŠ å¯†å­˜å‚¨ API Key
- é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨ä» `~/.claude/settings.json` è¿ç§»é…ç½®
- æä¾›é…ç½®çš„ CRUD æ“ä½œ

**æ•°æ®åº“è¡¨ç»“æ„ï¼š**
- `config` è¡¨ï¼šé”®å€¼å¯¹å­˜å‚¨ï¼ˆkeyã€valueã€encryptedã€createdAtã€updatedAtï¼‰

**åŠ å¯†ç­–ç•¥ï¼š**
```typescript
// API Key ä½¿ç”¨ safeStorage åŠ å¯†åå­˜å‚¨
if (key === 'apiKey' && safeStorage.isEncryptionAvailable()) {
  const encrypted = safeStorage.encryptString(value);
  // å­˜å‚¨ä¸º base64 ç¼–ç 
}
```

**é…ç½®è¿ç§»æµç¨‹ï¼š**
```
åº”ç”¨å¯åŠ¨
   â†“
æ£€æŸ¥ config.isConfigured()
   â†“ (false)
æ£€æŸ¥ ~/.claude/settings.json æ˜¯å¦å­˜åœ¨
   â†“ (true)
è°ƒç”¨ migrateFromClaudeSettings()
   â”œâ”€ è¯»å– primaryApiKey/apiKey
   â”œâ”€ è¯»å– model
   â”œâ”€ è¯»å– baseUrlï¼ˆoauth2Provider.apiBaseUrlï¼‰
   â””â”€ å­˜å‚¨åˆ° ConfigStore
```

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `get(key)` - è·å–é…ç½®å€¼ï¼ˆè‡ªåŠ¨è§£å¯†ï¼‰
- `set(key, value)` - è®¾ç½®é…ç½®å€¼ï¼ˆè‡ªåŠ¨åŠ å¯†æ•æ„Ÿæ•°æ®ï¼‰
- `isConfigured()` - æ£€æŸ¥æ˜¯å¦å·²é…ç½® API Key
- `getAll()` - è·å–æ‰€æœ‰é…ç½®ï¼ˆAPI Key è¿”å›æ©ç ï¼‰
- `migrateFromClaudeSettings()` - ä» Claude Code è¿ç§»é…ç½®

#### 4.1.7 `libs/claude-settings.ts` - ç¯å¢ƒå˜é‡æ„å»º
**èŒè´£ï¼š**
- ä» ConfigStore è¯»å–é…ç½®
- æ„å»º Claude Agent SDK æ‰€éœ€çš„ç¯å¢ƒå˜é‡
- æ¯æ¬¡è°ƒç”¨æ—¶åŠ¨æ€è·å–æœ€æ–°é…ç½®

**ç¯å¢ƒå˜é‡æ˜ å°„ï¼š**
```typescript
// ä» ConfigStore æ„å»ºç¯å¢ƒå˜é‡
ANTHROPIC_AUTH_TOKEN  // ä» ConfigStore.get('apiKey')
ANTHROPIC_BASE_URL    // ä» ConfigStore.get('baseUrl')
ANTHROPIC_MODEL       // ä» ConfigStore.get('model')
```

**è°ƒç”¨æ—¶æœºï¼š**
- `runner.ts` åœ¨å¯åŠ¨ Claude Agent æ—¶è°ƒç”¨ `getEnhancedEnv()`
- æ¯æ¬¡è°ƒç”¨éƒ½ä¼šä» ConfigStore è¯»å–æœ€æ–°é…ç½®
- ç”¨æˆ·åœ¨ SettingsModal ä¸­ä¿®æ”¹é…ç½®åç«‹å³ç”Ÿæ•ˆ

---

### 4.2 æ¸²æŸ“è¿›ç¨‹æ¨¡å— (Renderer Process)

#### 4.2.1 `App.tsx` - ä¸»åº”ç”¨ç»„ä»¶
**èŒè´£ï¼š**
- æ ¹ç»„ä»¶ï¼Œç»„ç»‡æ•´ä½“å¸ƒå±€
- é›†æˆ `Sidebar`ã€`PromptInput`ã€`EventCard`ã€`DecisionPanel`ã€`SettingsModal` ç­‰å­ç»„ä»¶
- å¤„ç†å…¨å±€é”™è¯¯æ˜¾ç¤º
- ç®¡ç†ä¼šè¯åˆ‡æ¢å’Œæ¶ˆæ¯å±•ç¤º
- **é¦–æ¬¡å¯åŠ¨æ£€æµ‹**ï¼šæ£€æŸ¥é…ç½®çŠ¶æ€ï¼Œæœªé…ç½®æ—¶è‡ªåŠ¨å¼¹å‡ºè®¾ç½®ç•Œé¢

**é¦–æ¬¡å¯åŠ¨æµç¨‹ï¼š**
```
App ç»„ä»¶æŒ‚è½½
   â†“
è°ƒç”¨ config.isConfigured
   â†“
æœªé…ç½® â†’ æ˜¾ç¤º SettingsModal
å·²é…ç½® â†’ æ­£å¸¸åŠ è½½ä¼šè¯åˆ—è¡¨
```

**UI ç»“æ„ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sidebar   â”‚  Main Content Area    â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  Sessions  â”‚  â”‚  Messages       â”‚  â”‚
â”‚  List      â”‚  â”‚  (EventCard[])  â”‚  â”‚
â”‚            â”‚  â”‚                 â”‚  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚            â”‚  â”‚  DecisionPanel  â”‚  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚            â”‚  â”‚  PromptInput    â”‚  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.2 `store/useAppStore.ts` - å…¨å±€çŠ¶æ€ç®¡ç†
**æŠ€æœ¯æ ˆï¼š** Zustand (è½»é‡çº§çŠ¶æ€ç®¡ç†)

**æ ¸å¿ƒçŠ¶æ€ï¼š**
```typescript
interface AppState {
  sessions: Record<string, SessionView>;  // ä¼šè¯æ˜ å°„è¡¨
  activeSessionId: string | null;         // å½“å‰æ¿€æ´»ä¼šè¯
  prompt: string;                         // è¾“å…¥æ¡†å†…å®¹
  cwd: string;                            // å·¥ä½œç›®å½•
  pendingStart: boolean;                  // å¯åŠ¨ä¸­çŠ¶æ€
  globalError: string | null;             // å…¨å±€é”™è¯¯
  sessionsLoaded: boolean;                // ä¼šè¯æ˜¯å¦å·²åŠ è½½
  showStartModal: boolean;                // æ˜¾ç¤ºå¯åŠ¨æ¨¡æ€æ¡†
  historyRequested: Set<string>;          // å·²è¯·æ±‚å†å²çš„ä¼šè¯
}
```

**SessionView ç»“æ„ï¼š**
```typescript
type SessionView = {
  id: string;
  title: string;
  status: SessionStatus;  // 'idle' | 'running' | 'completed' | 'error'
  cwd?: string;
  messages: StreamMessage[];
  permissionRequests: PermissionRequest[];
  lastPrompt?: string;
  hydrated: boolean;  // æ˜¯å¦å·²åŠ è½½å†å²
}
```

**å…³é”®æ–¹æ³•ï¼š**
- `handleServerEvent()` - å¤„ç†æ¥è‡ªä¸»è¿›ç¨‹çš„æ‰€æœ‰æœåŠ¡å™¨äº‹ä»¶
  - `session.list` - æ›´æ–°ä¼šè¯åˆ—è¡¨
  - `session.history` - æ³¨å…¥å†å²æ¶ˆæ¯
  - `session.status` - æ›´æ–°ä¼šè¯çŠ¶æ€
  - `stream.message` - è¿½åŠ æ¶ˆæ¯
  - `permission.request` - æ·»åŠ æƒé™è¯·æ±‚
- `resolvePermissionRequest()` - è§£å†³æƒé™è¯·æ±‚ï¼ˆç§»é™¤å·²å¤„ç†çš„è¯·æ±‚ï¼‰

#### 4.2.3 `hooks/useIPC.ts` - IPC é€šä¿¡ Hook
**èŒè´£ï¼š**
- å°è£… IPC é€šä¿¡é€»è¾‘
- ç®¡ç†äº‹ä»¶è®¢é˜…ç”Ÿå‘½å‘¨æœŸ
- æä¾› `sendEvent()` å’Œ `connected` çŠ¶æ€

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
const { connected, sendEvent } = useIPC((event) => {
  handleServerEvent(event);  // å¤„ç†æœåŠ¡å™¨äº‹ä»¶
});

// å‘é€å®¢æˆ·ç«¯äº‹ä»¶
sendEvent({ type: 'session.start', payload: {...} });
```

#### 4.2.4 UI ç»„ä»¶

##### `Sidebar.tsx` - ä¼šè¯ä¾§è¾¹æ 
- æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯åˆ—è¡¨
- æ”¯æŒåˆ‡æ¢æ¿€æ´»ä¼šè¯
- æ˜¾ç¤ºä¼šè¯çŠ¶æ€ï¼ˆè¿è¡Œä¸­ã€å·²å®Œæˆã€é”™è¯¯ï¼‰
- æä¾›åˆ é™¤ä¼šè¯åŠŸèƒ½
- **è®¾ç½®æŒ‰é’®**ï¼šåº•éƒ¨é½¿è½®å›¾æ ‡ï¼Œç‚¹å‡»æ‰“å¼€ SettingsModal

##### `PromptInput.tsx` - è¾“å…¥æ¡†ç»„ä»¶
- å¤šè¡Œæ–‡æœ¬è¾“å…¥ï¼ˆtextareaï¼‰
- æ”¯æŒ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
- æ˜¾ç¤ºå½“å‰å·¥ä½œç›®å½•
- å¯åŠ¨/ç»§ç»­ä¼šè¯æŒ‰é’®

##### `EventCard.tsx` - æ¶ˆæ¯å¡ç‰‡
- æ¸²æŸ“ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼š
  - `user_prompt` - ç”¨æˆ·è¾“å…¥
  - `thinking` - Agent æ€è€ƒè¿‡ç¨‹
  - `tool_use` - å·¥å…·è°ƒç”¨
  - `tool_result` - å·¥å…·ç»“æœ
  - `result` - æœ€ç»ˆç»“æœ
- ä½¿ç”¨ `react-markdown` + `rehype-highlight` æ¸²æŸ“ Markdown
- ä»£ç é«˜äº®æ˜¾ç¤º

##### `DecisionPanel.tsx` - æƒé™å†³ç­–é¢æ¿
- æ˜¾ç¤ºå¾…å¤„ç†çš„å·¥å…·æƒé™è¯·æ±‚
- æä¾›æ‰¹å‡†/æ‹’ç»æŒ‰é’®
- æ˜¾ç¤ºå·¥å…·åç§°å’Œè¾“å…¥å‚æ•°

##### `StartSessionModal.tsx` - å¯åŠ¨ä¼šè¯æ¨¡æ€æ¡†
- è¾“å…¥ä¼šè¯æ ‡é¢˜
- é€‰æ‹©å·¥ä½œç›®å½•ï¼ˆæ”¯æŒæµè§ˆå™¨é€‰æ‹©ï¼‰
- æ˜¾ç¤ºæœ€è¿‘ä½¿ç”¨çš„ç›®å½•
- é…ç½®å…è®¸çš„å·¥å…·åˆ—è¡¨

##### `SettingsModal.tsx` - API é…ç½®æ¨¡æ€æ¡†
- **API Key è¾“å…¥**ï¼šå¯†ç è¾“å…¥æ¡†ï¼Œæ”¯æŒæ˜¾ç¤º/éšè—åˆ‡æ¢
- **Base URL é…ç½®**ï¼šå¯é€‰ï¼Œç”¨äºè‡ªå®šä¹‰ API ç«¯ç‚¹
- **æ¨¡å‹é€‰æ‹©**ï¼šå¯é€‰ï¼Œè¦†ç›–é»˜è®¤æ¨¡å‹
- **è¿æ¥æµ‹è¯•**ï¼šéªŒè¯ API é…ç½®æ˜¯å¦æœ‰æ•ˆ
- **ä¿å­˜/å–æ¶ˆ**ï¼šé…ç½®å˜æ›´å³æ—¶ç”Ÿæ•ˆ

**é¦–æ¬¡å¯åŠ¨è¡Œä¸ºï¼š**
- è‡ªåŠ¨å¼¹å‡ºï¼Œä¸å¯å…³é—­ï¼ˆå¿…é¡»é…ç½® API Keyï¼‰
- é…ç½®å®Œæˆåè‡ªåŠ¨å…³é—­

**UI ç»“æ„ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš™ï¸ Settings                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  API Key *                     â”‚
â”‚  [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢]  ğŸ‘ï¸        â”‚
â”‚                                â”‚
â”‚  Base URL (optional)           â”‚
â”‚  [https://api.anthropic.com]   â”‚
â”‚                                â”‚
â”‚  Model (optional)              â”‚
â”‚  [claude-sonnet-4-20250514]    â”‚
â”‚                                â”‚
â”‚  [Test Connection]             â”‚
â”‚  âœ… Connection successful      â”‚
â”‚                                â”‚
â”‚         [Cancel]  [Save]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. æ•°æ®æµè¯¦è§£

### 5.1 å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·æ“ä½œ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI Component (React)                                    â”‚
â”‚  - ç”¨æˆ·ç‚¹å‡»"Start"                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ sendClientEvent({ type: 'session.start' })
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Preload Script (contextBridge)                          â”‚
â”‚  - window.electron.sendClientEvent()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ ipcRenderer.send('client-event')
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Main Process - ipc-handlers.ts                          â”‚
â”‚  â”œâ”€ handleClientEvent()                                  â”‚
â”‚  â”œâ”€ sessions.createSession()                             â”‚
â”‚  â”œâ”€ emit({ type: 'session.status', status: 'running' })  â”‚
â”‚  â””â”€ runClaude() â†’ Claude Agent SDK                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ Stream Messages
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude Agent SDK                                        â”‚
â”‚  â”œâ”€ è¿æ¥ Anthropic API                                   â”‚
â”‚  â”œâ”€ æµå¼è¾“å‡ºæ¶ˆæ¯ (thinking/tool_use/result)              â”‚
â”‚  â””â”€ è§¦å‘ onEvent() å›è°ƒ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ emit({ type: 'stream.message' })
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Main Process - broadcast()                              â”‚
â”‚  - å‘é€åˆ°æ‰€æœ‰çª—å£: win.webContents.send('server-event')  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ ipcRenderer.on('server-event')
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Preload Script                                          â”‚
â”‚  - window.electron.onServerEvent() è§¦å‘å›è°ƒ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI - useIPC Hook                                        â”‚
â”‚  - onEvent(event) â†’ handleServerEvent()                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Zustand Store - useAppStore                             â”‚
â”‚  â”œâ”€ æ›´æ–° sessions[sessionId].messages                    â”‚
â”‚  â”œâ”€ æ›´æ–° sessions[sessionId].status                      â”‚
â”‚  â””â”€ è§¦å‘ React é‡æ–°æ¸²æŸ“                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI Re-render                                            â”‚
â”‚  - EventCard æ˜¾ç¤ºæ–°æ¶ˆæ¯                                   â”‚
â”‚  - Sidebar æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 IPC äº‹ä»¶åè®®

#### å®¢æˆ·ç«¯äº‹ä»¶ (UI â†’ Main)
```typescript
type ClientEvent = 
  | { type: 'session.list' }
  | { type: 'session.history', payload: { sessionId: string } }
  | { type: 'session.start', payload: { cwd, title, prompt, allowedTools } }
  | { type: 'session.continue', payload: { sessionId, prompt } }
  | { type: 'session.stop', payload: { sessionId } }
  | { type: 'session.delete', payload: { sessionId } }
  | { type: 'permission.response', payload: { sessionId, toolUseId, result } }
  // é…ç½®ç®¡ç†äº‹ä»¶
  | { type: 'config.get' }
  | { type: 'config.set', payload: { apiKey?, baseUrl?, model? } }
  | { type: 'config.test', payload: { apiKey, baseUrl? } }
  | { type: 'config.isConfigured' }
```

#### æœåŠ¡å™¨äº‹ä»¶ (Main â†’ UI)
```typescript
type ServerEvent = 
  | { type: 'session.list', payload: { sessions } }
  | { type: 'session.history', payload: { sessionId, status, messages } }
  | { type: 'session.status', payload: { sessionId, status, title, cwd, error? } }
  | { type: 'stream.message', payload: { sessionId, message } }
  | { type: 'stream.user_prompt', payload: { sessionId, prompt } }
  | { type: 'permission.request', payload: { sessionId, toolUseId, toolName, input } }
  | { type: 'runner.error', payload: { sessionId?, message } }
  // é…ç½®ç®¡ç†å“åº”äº‹ä»¶
  | { type: 'config.data', payload: { apiKey, baseUrl?, model? } }
  | { type: 'config.saved' }
  | { type: 'config.testResult', payload: { success, error? } }
  | { type: 'config.isConfigured', payload: { configured: boolean } }
```

---

## 6. æŠ€æœ¯æ ˆæ€»ç»“

### 6.1 æ ¸å¿ƒä¾èµ–

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|-----|------|-----|
| Electron | 39.2.7 | è·¨å¹³å°æ¡Œé¢æ¡†æ¶ |
| React | 19.2.3 | UI æ¡†æ¶ |
| TypeScript | 5.9.3 | ç±»å‹å®‰å…¨ |
| Vite | 7.3.1 | å‰ç«¯æ„å»ºå·¥å…· |
| Zustand | 5.0.10 | çŠ¶æ€ç®¡ç† |
| better-sqlite3 | 12.6.0 | æœ¬åœ°æ•°æ®åº“ |
| @anthropic-ai/claude-agent-sdk | 0.2.6 | Claude Agent é›†æˆ |
| @anthropic-ai/claude-code | 0.2.109 | å†…ç½® Claude Code CLI |
| Tailwind CSS | 4.1.18 | æ ·å¼æ¡†æ¶ |

### 6.2 å¼€å‘å·¥å…·

- **åŒ…ç®¡ç†å™¨**: Bun (é¦–é€‰) / npm
- **ä»£ç æ£€æŸ¥**: ESLint + typescript-eslint
- **æ‰“åŒ…å·¥å…·**: electron-builder
- **Markdown æ¸²æŸ“**: react-markdown + rehype-highlight
- **ä»£ç é«˜äº®**: highlight.js

---

## 7. å…³é”®è®¾è®¡å†³ç­–

### 7.1 ä¸ºä»€ä¹ˆé€‰æ‹© Zustandï¼Ÿ
- è½»é‡çº§ï¼ˆ~1KBï¼‰ï¼Œæ€§èƒ½ä¼˜å¼‚
- ç®€æ´çš„ APIï¼Œæ— éœ€ Provider åŒ…è£¹
- TypeScript æ”¯æŒè‰¯å¥½
- é€‚åˆä¸­å°å‹åº”ç”¨çš„çŠ¶æ€ç®¡ç†

### 7.2 ä¸ºä»€ä¹ˆä½¿ç”¨ SQLiteï¼Ÿ
- æ— éœ€ç‹¬ç«‹æœåŠ¡å™¨ï¼ŒåµŒå…¥å¼æ•°æ®åº“
- äº‹åŠ¡æ”¯æŒï¼Œæ•°æ®å®Œæ•´æ€§ä¿è¯
- WAL æ¨¡å¼æé«˜å¹¶å‘æ€§èƒ½
- é€‚åˆæœ¬åœ°ä¼šè¯å†å²å­˜å‚¨

### 7.3 ä¸ºä»€ä¹ˆé‡‡ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Ÿ
- è§£è€¦ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹
- æ”¯æŒå¤šçª—å£å¹¿æ’­
- æ˜“äºæ‰©å±•æ–°äº‹ä»¶ç±»å‹
- ç¬¦åˆ Electron çš„è®¾è®¡ç†å¿µ

### 7.4 æƒé™æ§åˆ¶æœºåˆ¶
- åªå¯¹ `AskUserQuestion` å·¥å…·éœ€è¦ç”¨æˆ·æ‰¹å‡†
- å…¶ä»–å·¥å…·è‡ªåŠ¨æ‰¹å‡†ï¼ˆä¿¡ä»» Claude Agentï¼‰
- é€šè¿‡ `pendingPermissions` Map ç®¡ç†å¼‚æ­¥æƒé™å“åº”
- æ”¯æŒä¸­æ­¢æ—¶è‡ªåŠ¨æ‹’ç»

### 7.5 ç‹¬ç«‹è¿è¡Œä¸å®‰å…¨å­˜å‚¨
**ä¸ºä»€ä¹ˆå†…ç½® Claude Code CLIï¼Ÿ**
- ç”¨æˆ·æ— éœ€å•ç‹¬å®‰è£… Claude Code
- ç‰ˆæœ¬æ§åˆ¶ï¼šç¡®ä¿ CLI ç‰ˆæœ¬ä¸åº”ç”¨å…¼å®¹
- ç®€åŒ–å®‰è£…æµç¨‹ï¼šä¸‹è½½å³ç”¨

**ä¸ºä»€ä¹ˆä½¿ç”¨ Electron safeStorageï¼Ÿ**
- åˆ©ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„åŠ å¯†æœåŠ¡
  - macOS: Keychain
  - Windows: DPAPI
  - Linux: libsecret
- API Key åœ¨ç£ç›˜ä¸Šå§‹ç»ˆåŠ å¯†å­˜å‚¨
- åªæœ‰å½“å‰ç”¨æˆ·æ‰èƒ½è§£å¯†

**ä¸ºä»€ä¹ˆé¦–æ¬¡å¯åŠ¨è‡ªåŠ¨è¿ç§»é…ç½®ï¼Ÿ**
- æ— ç¼è¿‡æ¸¡ï¼šå·²æœ‰ Claude Code ç”¨æˆ·æ— éœ€é‡æ–°é…ç½®
- å•æ¬¡è¿ç§»ï¼šåªåœ¨é¦–æ¬¡å¯åŠ¨ä¸”æœªé…ç½®æ—¶æ‰§è¡Œ
- æ‰‹åŠ¨è¦†ç›–ï¼šç”¨æˆ·å¯éšæ—¶åœ¨è®¾ç½®ä¸­ä¿®æ”¹

---

## 8. æ‰©å±•æ€§ä¸ç»´æŠ¤

### 8.1 æ·»åŠ æ–°åŠŸèƒ½çš„æ­¥éª¤

1. **å®šä¹‰äº‹ä»¶ç±»å‹** (åœ¨ `types.ts`)
   ```typescript
   type NewClientEvent = { type: 'feature.action', payload: {...} }
   ```

2. **å®ç°ä¸»è¿›ç¨‹å¤„ç†** (åœ¨ `ipc-handlers.ts`)
   ```typescript
   if (event.type === 'feature.action') {
     // å¤„ç†é€»è¾‘
     emit({ type: 'feature.response', payload: {...} });
   }
   ```

3. **æ›´æ–° Zustand Store** (åœ¨ `useAppStore.ts`)
   ```typescript
   case 'feature.response': {
     // æ›´æ–°çŠ¶æ€
   }
   ```

4. **åˆ›å»º UI ç»„ä»¶** (åœ¨ `components/`)
   ```typescript
   export function NewFeature() {
     const sendEvent = useAppStore(s => s.sendEvent);
     // å®ç° UI
   }
   ```

### 8.2 è°ƒè¯•å»ºè®®

- **ä¸»è¿›ç¨‹æ—¥å¿—**: ä½¿ç”¨ `console.log()` ä¼šè¾“å‡ºåˆ°ç»ˆç«¯
- **æ¸²æŸ“è¿›ç¨‹æ—¥å¿—**: ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆElectron DevToolsï¼‰
- **æ•°æ®åº“æ£€æŸ¥**: ä½¿ç”¨ SQLite å®¢æˆ·ç«¯æŸ¥çœ‹ `sessions.db`
- **IPC äº‹ä»¶è¿½è¸ª**: åœ¨ `handleClientEvent()` å’Œ `handleServerEvent()` æ·»åŠ æ—¥å¿—

---

## 9. æ€»ç»“

Open Claude Cowork é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¶æ„ï¼Œå®ç°äº†ï¼š

âœ… **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**ï¼šä¸»è¿›ç¨‹è´Ÿè´£ä¸šåŠ¡é€»è¾‘å’Œç³»ç»Ÿäº¤äº’ï¼Œæ¸²æŸ“è¿›ç¨‹è´Ÿè´£ UI å±•ç¤º  
âœ… **å®‰å…¨çš„ IPC é€šä¿¡**ï¼šé€šè¿‡ Preload Script å’Œ contextBridge ç¡®ä¿å®‰å…¨  
âœ… **å¯é çš„æ•°æ®æŒä¹…åŒ–**ï¼šSQLite æä¾›äº‹åŠ¡æ”¯æŒå’Œæ•°æ®å®Œæ•´æ€§  
âœ… **å“åº”å¼çš„ç”¨æˆ·ä½“éªŒ**ï¼šZustand + React å®ç°é«˜æ•ˆçŠ¶æ€ç®¡ç†å’Œ UI æ›´æ–°  
âœ… **çµæ´»çš„æ‰©å±•æ€§**ï¼šäº‹ä»¶é©±åŠ¨æ¶æ„ä¾¿äºæ·»åŠ æ–°åŠŸèƒ½  
âœ… **ç‹¬ç«‹è¿è¡Œèƒ½åŠ›**ï¼šå†…ç½® Claude Code CLIï¼Œæ— éœ€ç”¨æˆ·å•ç‹¬å®‰è£…  
âœ… **å®‰å…¨çš„é…ç½®å­˜å‚¨**ï¼šä½¿ç”¨ Electron safeStorage åŠ å¯† API Key

æ•´ä½“æ¶æ„éµå¾ª Electron æœ€ä½³å®è·µï¼Œä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚
